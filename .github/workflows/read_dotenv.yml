name: Read key from dotenv

on:
  workflow_call:
    inputs:
      key:
        description: "The key to load from the .env file"
        required: true
        type: string
      sha:
        description: "Optional Git SHA to checkout before reading .env"
        required: false
        type: string
        default: ""
    outputs:
      value:
        description: "Value loaded from dotenv corresponding to the provided key"
        value: ${{ jobs.read-dotenv-key.outputs.value }}

jobs:
  read-dotenv-key:
    runs-on: ubuntu-22.04
    outputs:
      value: ${{ steps.read-dotenv-key.outputs.value }}
    steps:
      - name: Checkout (use sha if provided)
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          ref: ${{ inputs.sha || github.sha }}

      - name: Read "${{ inputs.key }}" from .env file
        id: read-dotenv-key
        run: |
          VALUE=$(grep -v '^#' .env | grep -E "^${{ inputs.key }}=" | cut -d '=' -f2-)
          if [[ -z "$VALUE" ]]; then
            echo "Key '${{ inputs.key }}' not found in .env"
            exit 1
          fi
          echo "value=$VALUE" >> "$GITHUB_OUTPUT"

      - name: Verify "${{ inputs.key }}" loaded correctly
        run: |
          echo "${{ inputs.key }} is ${{ steps.read-dotenv-key.outputs.value }}"
