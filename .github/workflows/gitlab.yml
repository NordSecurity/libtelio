name: GitLab CI Pipeline
on:
  pull_request_target:
    types: [labeled]
  push:
    branches-ignore:
      - 'gh-readonly-queue/**'
      - 'main-[0-9]*-[a-zA-Z0-9]*'
  merge_group:
    types: [checks_requested]
permissions: {}

jobs:
  read-triggered-ref:
    uses: ./.github/workflows/read_dotenv.yml
    with:
      key: TRIGGERED_REF

  trigger-gitlab-pipeline:
    needs: read-triggered-ref
    uses: NordSecurity/trigger-gitlab-pipeline/.github/workflows/trigger-gitlab-pipeline.yml@ebb921c37827524c496ab00c7d9b1cabbfdd796b
    secrets:
      ci-api-v4-url: ${{ secrets.CODEHUB_CI_API_V4_URL }}
      access-token: ${{ secrets.CODEHUB_GITLAB_API_TOKEN }}
      trigger-token: ${{ secrets.CODEHUB_TOKEN }}
      project-id: ${{ secrets.CODEHUB_PROJECT_ID }}
    with:
      cancel-outdated-pipelines: ${{ github.ref_name != 'main' }}
      triggered-ref: ${{ needs.read-triggered-ref.outputs.value }} # defined in .env file
