name: Fuzzing
on: [workflow_call]
permissions: {}

jobs:
  telio-proto-fuzzing:
      runs-on: ubuntu-22.04
      steps:
        - uses: actions/checkout@1d96c772d19495a3b5c517cd2bc0cb401ea0529f # v4.1.3
        - uses: actions-rs/toolchain@b2417cde72dcf67f306c0ae8e0828a81bf0b189f # v1.0.6
          with:
            toolchain: nightly-2023-06-01
            override: true
        - run: cargo install cargo-fuzz --locked --version 0.11.2
        - name: fuzz telio proto
          working-directory: crates/telio-proto
          run: cargo fuzz run packet -- -max_total_time=180
  telio-crypto-fuzzing:
      runs-on: ubuntu-22.04
      steps:
        - uses: actions/checkout@1d96c772d19495a3b5c517cd2bc0cb401ea0529f # v4.1.3
        - uses: actions-rs/toolchain@b2417cde72dcf67f306c0ae8e0828a81bf0b189f # v1.0.6
          with:
            toolchain: nightly-2023-06-01
            override: true
        - run: cargo install cargo-fuzz --locked --version 0.11.2
        - name: fuzz telio crypto decrypt_request
          working-directory: crates/telio-crypto
          run: cargo fuzz run decrypt_request -- -max_total_time=180
        - name: fuzz telio crypto decrypt_request_inner
          working-directory: crates/telio-crypto
          run: cargo fuzz run decrypt_request_inner -- -max_total_time=180
        - name: fuzz telio crypto decrypt_response
          working-directory: crates/telio-crypto
          run: cargo fuzz run decrypt_response -- -max_total_time=180
  telio-pq-fuzzing:
      runs-on: ubuntu-22.04
      steps:
        - uses: actions/checkout@1d96c772d19495a3b5c517cd2bc0cb401ea0529f # v4.1.3
        - uses: actions-rs/toolchain@b2417cde72dcf67f306c0ae8e0828a81bf0b189f # v1.0.6
          with:
            toolchain: nightly-2023-06-01
            override: true
        - run: cargo install cargo-fuzz --locked --version 0.11.2
        - name: fuzz telio pq parse_get_packet
          working-directory: crates/telio-pq
          run: CARGO_CFG_CURVE25519_DALEK_BACKEND="serial" cargo fuzz run parse_get_packet -- -max_total_time=180
        - name: fuzz telio pq parse_rekey_packet
          working-directory: crates/telio-pq
          run: CARGO_CFG_CURVE25519_DALEK_BACKEND="serial" cargo fuzz run parse_rekey_packet -- -max_total_time=180
