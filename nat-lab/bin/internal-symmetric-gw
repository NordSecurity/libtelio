#!/usr/bin/env bash

set -e

# This is a workaround for 6.x kernel bug, which can cause NULL-deref when
# iptables are executed too early at boot.
# More details:
# https://lore.kernel.org/netdev/20240731213046.6194-3-pablo@netfilter.org/T/#m597226ed32420a20bca5be58cf1c21073f06083b
sleep 5

# Configure standard FW
iptables -t filter -A INPUT -i lo -j ACCEPT
iptables -t filter -A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
iptables -t filter -P INPUT DROP

# Configure symmetric NAT
iptables -t nat -A POSTROUTING -o eth1 -j MASQUERADE --random
iptables -A FORWARD -i eth1 -o eth0 -m state --state RELATED,ESTABLISHED -j ACCEPT
iptables -A FORWARD -i eth0 -o eth1 -j ACCEPT

/libtelio/nat-lab/bin/configure_route.sh secondary

touch /ready

sleep infinity
