#!/usr/bin/env bash

set -euxo pipefail

up() {
  local service="$1"
  echo "$service: enable + start"
  if systemctl enable --now "$service" && systemctl is-active --quiet "$service"; then
    echo "OK: $service"
  else
    echo "FAIL: $service"
    systemctl status "$s" --no-pager || true
    exit 1
  fi
}

# This is a workaround for 6.x kernel bug, which can cause NULL-deref when
# iptables are executed too early at boot.
# More details:
# https://lore.kernel.org/netdev/20240731213046.6194-3-pablo@netfilter.org/T/#m597226ed32420a20bca5be58cf1c21073f06083b
sleep 5

# Backup IP tables
iptables-save -f iptables_backup
ip6tables-save -f ip6tables_backup

echo "Setting up services..."
systemctl daemon-reload
up nlx-quick@nordlynx0
up nlx-radius
up fakefm.service
up pq-upgrader
up nlx-ns

touch /ready
